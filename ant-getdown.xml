<project name="Tiny Media Manager">

    <property name="build.dir" value="${project.build.directory}/${project.artifactId}-getdown"/>
    <property name="lib.dir" value="${build.dir}/lib"/>
    <property name="getdown" value="getdown.txt"/> <!-- set as property to override from outside -->

    <target name="getdown" description="adds our dependencies to getdown code libs">
		<echo level="info" message="generating build info"/>
		<propertyfile file="${build.dir}/version" comment="This file is automatically generated - DO NOT EDIT">
			<entry key="version" value="${project.version}"/>
			<entry key="human.version" value="${human.version}"/>
			<entry key="build" value="${tmmRevision}"/>
			<entry key="date" value="${tmmTimestamp}"/>
		</propertyfile>

		<!-- not in GD, but here is the easiest way to replace the version numbers -->
		<replace file="${build.dir}/macOS/Info.plist" token="%VERSION%" value="${human.version}"/>
		<replace file="${build.dir}/macOS/Info.plist" token="%SVNREV%" value="${tmmRevision}"/>

		<echo level="info" message="replacing classpath libs"/>
		<path id="classpath.default">
			<fileset dir="${lib.dir}">
				<include name="*.jar"/>
			</fileset>
		</path>
		<pathconvert property="gd.code" refid="classpath.default" pathsep="">
			<mapper>
				<chainedmapper>
					<flattenmapper />
					<!-- remove absolute path -->
					<!-- add GD + lib/ prefix + newline ;) -->
					<globmapper from="*" to="code = lib/*${line.separator}" />
				</chainedmapper>
			</mapper>
		</pathconvert>
        <!--echo level="info" message="${gd.code}" /-->
		<copy file="AppBundler/${getdown}" tofile="${build.dir}/getdown.txt" />
		<replace file="${build.dir}/getdown.txt" token="%CODELIBS%" value="${gd.code}" />

        <echo level="info" message="generating GetDown files..."/>
		<taskdef name="digest" classname="com.threerings.getdown.tools.DigesterTask">
			<classpath>
				<pathelement location="AppBundler/libs/getdown-ant.jar" />
				<pathelement location="AppBundler/libs/getdown-core.jar" />
			</classpath>
		</taskdef>
		<digest appdir="${build.dir}" />
	</target>
</project>